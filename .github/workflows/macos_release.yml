name: MacOS Release
# This workflow is triggered on pushes to the repository. This is machine tests that everything is set for a release
# build. The binaries produced here can be used to make the release

#on: [push]
on:
  schedule:
    # Run this every wednesday at 3:50. https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#schedule
    - cron: '50 3 * * 3'

jobs:
  release_built:
    name: Build pkg from source
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest-large
            arch: amd
          - os: macos-latest-xlarge
            arch: arm
    env:
      RELEASE_VERSION: 2.7.2
      SO_VERSION: 2
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: Install prerequisites
        run: |
          set -x
          brew update
          brew install check gengetopt help2man opensc zlib
          brew reinstall openssl@3

      - name: Build MacOS binaries
        env:
          ARCH: ${{ matrix.arch }}
        run: |
          set -x

          echo "GITHUB_WORKSPACE = $GITHUB_WORKSPACE"
          ls -l $GITHUB_WORKSPACE

          ./resources/macos/make_release_binaries.sh $ARCH $RELEASE_VERSION $SO_VERSION $GITHUB_WORKSPACE
          mkdir $GITHUB_WORKSPACE/artifact
          mv resources/macos/yubico-piv-tool-$RELEASE_VERSION-mac-$ARCH.zip $GITHUB_WORKSPACE/artifact/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: yubico-piv-tool-mac-${{ matrix.arch }}64
          path: artifact
